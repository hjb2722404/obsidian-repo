# 采编编辑器二次开发功能点整理

## ueditor.js

### 使用渠道

* I我-新闻稿
* I我-视频稿
* 纸媒-新闻稿
* 网站-新闻稿
* 网站-视频稿
* 微博-头条文章（新媒体渠道）
* 头条号-新闻稿（新媒体渠道）
* 企鹅号-新闻稿（新媒体渠道）
* 百家号-新闻稿（新媒体渠道）

### 功能点

1. 一键排版设置调整：由于各个渠道的编辑器一键排版设置需要独立缓存，所以需要重写编辑器一键排版设置的缓存设置和读取方法；
2. 初始化编辑器工具条
3. 针对I我渠道-工具条剔除一些按钮功能
4. 针对纸媒渠道-工具条剔除一些按钮功能
5. 针对微信渠道-工具条剔除一些按钮功能【没有必要，应该去除】
6. 针对网站渠道-工具条剔除一些按钮功能
7. 针对新媒体渠道-工具条剔除一些按钮功能
8. 为所有渠道添加【纯文本粘贴模式】按钮
9. 初始化编辑器
10. `ready`事件处理逻辑
    1. 增加新增分页和删除分页的点击事件监听【分页功能取消，此处应该去除】
    2. 视频默认封面图处理-若转码完成替换封面图【异步】【处理完成会触发`setContent`方法】
    3. 获取编辑器语言
    4. 实时双向绑定-实时更新编辑器内当前实际字数【`keyup`事件】【`contentChange`事件】【定时器】
    5. 编辑器必填提示【`contentChange`事件】
    6. 计算编辑器内已选中部分的字数，并显示出来【`mouseup`事件】【`keydown`事件】
    7. 查看痕迹后或进入源码模式下禁用编辑器按钮【`selectionchange`事件】
    8. 如果当前没有文字被选中，则隐藏`已选中`字数提示【`selectionchange`事件】
    9. 编辑器失焦时已选字数显示消失【`blur`事件】
    10. 如果存在本地版本缓存，则比较本地版本与当前版本的差异，并开始定时保存本地版本
    11. 修复全屏bug【`fullscreenchanged`事件】
    12. 针对纸媒渠道-自动排版【完成后会触发`contentchange`事件】
    13. 针对纸媒渠道-强制设置粘贴模式为纯文本粘贴模式【`beforepaste`事件】
11. 编辑器销毁时销毁定时器
12. 监控`metadataid`[`$scope.list.METADATAID`]变化，并将正文更新进入本地版本
13. 遍历按钮方法，实例化按钮，并返回按钮对象
14. 重写全屏方法【内部是在`ready`事件中处理的】【内部监听了编辑器全屏时的`scroll`事件】
15. 编辑器图片编辑工具条初始化【插件】【内部监听`selectionchange`事件】
16. 点击触发外部播放器【插件】【内部监听`click`事件】
17. 图文补丁【插件】【内部在`ready`事件处理中监听`keydown`事件，`click`事件，`dragstart`事件，在`ready`事件之外监听了`selectionchange`事件】
    * `keydown`事件
      * 修复图片区域的键盘事件
      * 图说的回车事件处理
      * 修复图说后面的文字退格bug
    * `click`事件：在图片前后点击选中整个图片和图说区域
    * `dragstart`事件：【目前没有设置回调，可删除】
    * `selectionchange`事件： 修复图片与图说格式【图片预下载（异步）】
18. 编辑器销毁时，销毁非135编辑器【可与第11步合并】
19. 编辑器实现空格缩进【插件】【监听`keyup`事件】
20. 点击编辑器HTML源码后的处理逻辑【插件】【监听`afterSetContent`事件】
    * 兼容移动端的HTML标签格式(去除安卓移动端的空换行)【会重新设置编辑器的`html`内容】
    * 绘制视频的播放按钮
21. 正文结构强制修复【插件】【监听`selectionchange`事件】
    * 修复图片插入到段落文字中间后后面的文字没有标签包裹的问题
    * 去除最大宽度为0的图片
    * 移除失败图片提示（当检测到失败图片被删除）
    * 移除失败图片（当检测到失败提示被删除）



## ueditor-for-app.js

### 使用渠道

* 客户端-活动
* 客户端-音频
* 客户端-新闻
* 客户端-视频

### 功能点

1. 初始化新功能数组（主要是判断是否要添加135编辑器或秀米编辑器插件）
2. 动态加载135或秀米插件
3. 一键排版设置调整
4. 初始化编辑器工具条
5.  如果配置了自定义字体，则将编辑器默认工具条中的字体选择器默认选中自定义的字体
6. 添加[纯文本粘贴模式]按钮
7. `ready`事件处理逻辑
   1. 增加新增分页和删除分页的点击事件监听【分页功能取消，此处应该去除】
   2. 替换分页符标识【分页功能取消，此处应该去除】
   3. 视频默认封面图处理-若转码完成替换封面图【异步】【处理完成会触发`setContent`方法】
   4. 获取编辑器语言
   5. 如果目标是导语，则不允许再插入导语【监听`click`事件】
   6. 实时双向绑定-实时更新编辑器内当前实际字数【`keyup`事件】【`contentChange`事件】【定时器】
   7. 编辑器必填提示【`contentChange`事件】
   8. 计算编辑器内已选中部分的字数，并显示出来【`mouseup`事件】【`keydown`事件】
   9. 查看痕迹后或进入源码模式下禁用编辑器按钮【`selectionchange`事件】
   10. 如果当前没有文字被选中，则隐藏`已选中`字数提示【`selectionchange`事件】
   11. 禁止互相插入内部【监听`selection`事件】
   12. 初始化插入开关
   13. 编辑器失焦时已选字数显示消失【`blur`事件】
   14. 如果存在本地版本缓存，则比较本地版本与当前版本的差异，并开始定时保存本地版本
   15. 修复全屏bug【`fullscreenchanged`事件】
8. 编辑器销毁时销毁定时器
9. 监控`metadataid`[`$scope.list.METADATAID`]变化，并将正文更新进入本地版本
10. 遍历客户端按钮方法，实例化按钮，并返回按钮对象
11. 客户端渠道编辑器图片编辑工具条初始化【插件】【内部监听`selectionchange`事件】
12. 点击触发外部播放器【插件】【内部监听`click`事件】
13. 添加点击活动或广告图片的逻辑【插件】【内部监听`click`事件】
14. 图文补丁【插件】【内部在`ready`事件处理中监听`keydown`事件，`click`事件，`dragstart`事件，在`ready`事件之外监听了`selectionchange`事件】
15. 重写全屏方法【内部是在`ready`事件中处理的】【内部监听了编辑器全屏时的`scroll`事件】
16. 点击编辑器HTML源码后的处理逻辑【插件】【监听`afterSetContent`事件】
17. 重写百度编辑器的setContent方法，初始化时，禁用官员标签的链接和编辑功能
18. 重写百度编辑器的getContent方法，提交正文时，启用官员标签的链接和编辑功能
19. 组件中的回车事件【在`ready`增加对`kdydown`事件的监听】【内部完成处理后会触发`contentchagne`事件】【目前不知道哪里用到】
20. 图片组件中，选中图片后按删除按键，直接删除整个组件【同上】
21. 删除组件【同上】
22. 自定义标签拖拽功能【监听`contentchagne`事件】
23. 销毁编辑器时保存正文内容，销毁非135编辑器【可与第8步合并】
24. 编辑器实现空格缩进【插件】【监听`keyup`事件】
25. 正文结构强制修复【插件】【监听`selectionchange`事件】

## ueditor-for-weixin.js

### 使用渠道

* 微信

### 功能点

1. 动态加载135插件和秀米插件
2. 一键排版设置调整
3. 初始化编辑器工具条
4. 遍历按钮方法，实例化按钮，并返回按钮对象
5. 添加[纯文本粘贴模式]按钮
6. `ready`事件处理逻辑
   1. 增加新增分页和删除分页的点击事件监听【分页功能取消，此处应该去除】
   2. 替换分页符标识【分页功能取消，此处应该去除】
   3. 视频默认封面图处理-若转码完成替换封面图【异步】【处理完成会触发`setContent`方法】
   4. 获取编辑器语言
   5. 实时双向绑定-实时更新编辑器内当前实际字数【`keyup`事件】【`contentChange`事件】【定时器】
   6. 编辑器必填提示【`contentChange`事件】
   7. 计算编辑器内已选中部分的字数，并显示出来【`mouseup`事件】【`keydown`事件】
   8. 查看痕迹后或进入源码模式下禁用编辑器按钮【`selectionchange`事件】
   9. 如果当前没有文字被选中，则隐藏`已选中`字数提示【`selectionchange`事件】
   10. 编辑器失焦时已选字数显示消失【`blur`事件】
   11. 如果存在本地版本缓存，则比较本地版本与当前版本的差异，并开始定时保存本地版本
   12. 修复全屏bug【`fullscreenchanged`事件】
7. 编辑器销毁时销毁定时器
8. 监控`metadataid`[`$scope.list.METADATAID`]变化，并将正文更新进入本地版本
9. 重写全屏方法【内部是在`ready`事件中处理的】【内部监听了编辑器全屏时的`scroll`事件】
10. 微信渠道编辑器图片编辑工具条初始化【插件】【内部监听`selectionchange`事件】
11. 点击触发外部播放器【插件】【内部监听`click`事件】
12. 编辑器销毁时，销毁非135编辑器【可与第7步合并】
13. 编辑器实现空格缩进【插件】【监听`keyup`事件】
14. 非站内图片预下载【异步】【会触发`setContent`方法】
15. 点击编辑器HTML源码后的处理逻辑【插件】【监听`afterSetContent`事件】
16. 融合渠道微信编辑器将图说提取为正文【监听`contentchagne`事件】
17. 替换微信渠道编辑器的视频与音频，腾讯视频转为腾讯播放地址，非腾讯视频与音频替换为默认图并展示错误提示【监听`selectionchange`事件】
18. 正文结构强制修复【插件】【监听`selectionchange`事件】

## ueditor-for-atlas.js

### 使用渠道

* 所有图集稿

### 功能点

1. 一键排版设置调整
2. 初始化编辑器工具条
3. `ready`事件处理逻辑
   1. 设置内容【触发`setContent`方法】【应该添加编辑模式判断】
   2. 兼容大数据取稿字数算法不同问题
   3. 实时双向绑定-实时更新编辑器内当前实际字数【`keyup`事件】【`contentChange`事件】【定时器】
   4. 编辑器必填提示【`contentChange`事件】
   5. 计算编辑器内已选中部分的字数，并显示出来【`mouseup`事件】【`keydown`事件】
   6. 查看痕迹后或进入源码模式下禁用编辑器按钮【`selectionchange`事件】
   7. 如果当前没有文字被选中，则隐藏`已选中`字数提示【`selectionchange`事件】
   8. 编辑器失焦时已选字数显示消失【`blur`事件】
   9. 编辑器销毁时，销毁非135编辑器
   10. 编辑器实现空格缩进【插件】【监听`keyup`事件】

## 功能点详细分析

### 1.一键排版设置调整

`ueditorService.rewriteAutotypesetCache(UE);`

编辑器默认会自动将用户的一键排版配置存储到缓存中，在用户打开一键排版窗口时，如果有缓存，将应用缓存中的配置作为默认配置。
但是默认的缓存方法是不区分渠道的，而我们在新疆的项目中接到的需求时，需要根据不同渠道分别缓存那个渠道下的一键排版设置。所以我们对编辑器默认的缓存方法进行了改写。

主要逻辑为：
```javascript

// 设置一键排版配置缓存

UE.Editor.prototype.setPreferences = function(key, value,media) {
//...
};

// 获取一键排版配置缓存
UE.Editor.prototype.getPreferences = function(key,media) {
	//...
}

// 删除一键排版配置缓存
UE.Editor.prototype.removePreferences = function(key， media) {
// ...
}

```

> 重构时考虑是否将此配置存入indexDB

### 2. 初始化工具条

1. 获取通用基础的工具条配置：`editorToolBar = ueditorService.getToolBar()`

```javascript

getToolBar: function() {

	return {
	
		toolbars: [], // 工具条功能配置，默认包含所有功能
		labelMap: {}, // 自定义功能的名称
		maximumWords: 100000, // 最大字数限制 
		autoHeightEnabled: true, // 编辑器是否根据内容自动调整高度
		topOffset: 60, // 工具条距离编辑器顶部的距离
		enableContextMenu: false, 是否允许右键，默认禁止
		allowDivTransToP: true, // 允许将DIV元素转换为P元素
		imageScaleEnabled: true, // 是否允许缩放图片
		pasteplain: false, // 是否允许纯文本粘贴
		fontsize: [], // 字号列表
		fontsizename: [], // 字号对应的中文名称列表
		fontfamily: [], // 字体列表
}

}
```
获取到工具调后，可以通过处理`toolbars` 数组来定制某个渠道和某个稿件类型时编辑器功能的删减。
当然，也可以通过修改这个对象的其它选项来修改对应的配置，比如增加纯文本粘贴功能等。

处理后，在获取编辑器实例时将工具条配置传入即可：
```javascript
ue = UE.getEditor('ueditor', editorToolBar);
```

目前的问题：定制功能需要查找每一个功能在初始功能数组中的下标位置，然后通过传入下标来增加或减少编辑器功能按钮。重构时可以考虑使用功能名称配置数组来过滤功能。（通用基础功能 + 可定制功能）

### 3. 加载135和秀米插件
目前135插件与秀米插件只在APP渠道和微信渠道使用，因为这两个渠道的文章最终需要发布到移动端阅读，所以需要利用这两个插件来进行适应移动端的排版。

