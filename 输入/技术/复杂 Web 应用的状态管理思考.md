复杂 Web 应用的状态管理思考

# 复杂 Web 应用的状态管理思考

[[webp](../_resources/4c55a6ad8dd9b744aa2eb13a22c45e78.webp)](https://www.jianshu.com/u/60f22559b79f)

[binggg_booker](https://www.jianshu.com/u/60f22559b79f)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='275'%3e%3cpath d='M751.144277 307.2l-123.016533-238.933333h159.778133a81.92 81.92 0 0 1 59.1872 25.258666l160.256 167.492267A27.306667 27.306667 0 0 1 987.620011 307.2h-236.475734z m270.506667 111.547733L640.927744 946.039467a27.306667 27.306667 0 0 1-48.128-24.234667L766.504277 375.466667h-56.388266l-170.5984 590.165333a27.306667 27.306667 0 0 1-52.462934 0.034133L315.500544 375.466667H259.112277l174.523734 545.5872a27.306667 27.306667 0 0 1-48.128 24.302933L5.160277 418.747733A27.306667 27.306667 0 0 1 27.346944 375.466667H999.464277a27.306667 27.306667 0 0 1 22.152534 43.281066zM18.301611 261.0176L178.557611 93.525333A81.92 81.92 0 0 1 237.744811 68.266667h159.744L274.506411 307.2H38.030677a27.306667 27.306667 0 0 1-19.729066-46.1824zM453.877077 68.266667h117.896534l122.9824 238.933333H330.894677l122.9824-238.933333z' data-evernote-id='158' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*0.2632017.03.31 18:57:22字数 2,204阅读 2,550

## 目录

- 1.背景
- 2.一个常见的多个组件共享状态的问题
- 3.MVC 架构
- 4.Flux 架构
- 5.MVC 与 Flux 的对比
- 6.Vue.js 的 Vuex 方案
- 7.使用 Vuex 的正确姿势
- 8.只有 Vuex 还不够...
- 9.结语
- 10.推荐阅读

## 1.背景

### Web 页面开发的应用化趋势

随着 Web 能力的不断提升，用户的 Web 页面体验的要求，要求像原生一样，无刷新、离线缓存等和原生应用的功能。

![64173-b01dcbab6c8a18cb.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20201231111751.png)
Coding WebIDE

### Web 开发已经进入组件化时代

![64173-1221d172c1845a53.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20201231111906.png)
Web页面开发组件化

## 2.一个常见的多个组件共享状态的问题

在下图中播放器组件上点赞以后，如何同步更新其他地方有关这个视频的点赞信息，比如右侧信息区组件、详情页？

![64173-febad860e38eb70f.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112252.png)
点赞以后如何更新点赞的状态

### 可能的解决方案

- 方案 1：刷新页面
- 方案 2：把所有涉及到的接口都重新请求一遍
- 方案 3: 直接更改 Dom

...

### 这些方案的问题

- 方案 1: 体验差，会丢失用户的当前操作状态
- 方案 2: 多余的请求，网络请求需要耗时
- 方案 3：很难维护，也容易遗漏

**> 问题的根源：**
> 不同视图上的相同数据没有一个统一的来源，如果点赞信息能统一存储，只需要更新同一个地方，并且都从这个地方获取信息显示到视图上，就不会有这个问题了

## 3.MVC 架构

**> MVC 模式**> （Model–view–controller）是> [> 软件工程](https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B)> 中的一种> [> 软件架构](https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84)> 模式，把软件系统分为三个基本部分：模型（Model）、视图（View）和控制器（Controller）。

![64173-d601179e1b0ce68a.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112350.png)
MVC组件之间的典型合作

比如点赞信息作为一个 Model, 每个视图都可以读取这个 Model，然后视图通过通知 Controller 去更新 Model，视图通过监听 Model 的变化再进行同步。

![64173-f346f0413f6bf3fa.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112417.png)
mvc的数据流动

## 4.Flux 架构

Flux 是由 Facebook 提出的，用于组织应用的一种架构，它基于一个简单的原则：**数据在应用中单向流动**。这就是所谓的“单向数据流”

，简单的记法是把数据比作鲨鱼：[鲨鱼只能向前游](http://animalquestions.org/fish/sharks/can-sharks-swim-backwards/)。

![64173-5da7ccdfd3c1710d.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112424.png)
Paste_Image.png

![64173-5cadcdc5beac4bf4.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112428.png)
flux架构设计

Flux 试图通过强制单向数据流来解决这个复杂度。在这种架构当中，Views 查询 Stores（而不是 Models），并且用户交互将会触发 Actions，Actions 则会被提交到一个集中的 Dispatcher 当中。当 Actions 被派发之后，Stores 将会随之更新自己并且通知 Views 进行修改。这些 Store 当中的修改会进一步促使 Views 查询新的数据。

## 5.MVC 与 Flux 的对比

### EventBus 数量

- MVC： 一个 model 一个
- Flux： 只有一个

### 视图同步数据方式

- MVC：view 监听 model 的事件
- Flux： model 的改变自动同步到视图

### 查询和写入数据的区别

- MVC：Model 暴露给 View，View 有可能会更新 model，像 backbone 就可以在 View 里调用`this.model.set()`
- Flux： View 从 Store 获取的数据是只读的, Stores 只能通过 Actions 被更新

### 数据改变的可感知性

- MVC：由于有多个 EventBus，所以很难去定位改变了 model 的具体来源
- Flux： 任何状态的变化都必须通过 action 触发，而 action 又必须通过 dispatcher 走，所以整个应用的每一次状态变化都会从同一个地方流过

![64173-0b4fa9e7f0dab1f7.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201231112434.png)
复杂的Flux

## 6.Vuex

> Vuex 是一个专为 Vue.js 应用程序开发的**> 状态管理模式**> 。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。

> 借鉴了 > [> Flux](https://facebook.github.io/flux/docs/overview.html)> 、> [> Redux](http://redux.js.org/)> 、和 > [> The Elm Architecture](https://guide.elm-lang.org/architecture/)> 。与其他模式不同的是，Vuex 是专门为 Vue.js 设计的状态管理库，以利用 Vue.js 的细粒度数据响应机制来进行高效的状态更新。

### 多个组件共享状态的问题

由于 Flux 架构有多个 store，我们的应用遇到**多个组件共享状态**时，单向数据流的简洁性很容易被破坏：

- 多个视图依赖于同一状态。
- 来自不同视图的行为需要变更同一状态。

### 问题的解决

- 对于问题一，传参的方法对于多层嵌套的组件将会非常繁琐，并且对于兄弟组件间的状态传递无能为力。
- 对于问题二，我们经常会采用父子组件直接引用或者通过事件来变更和同步状态的多份拷贝。以上的这些模式非常脆弱，通常会导致无法维护的代码。

### 最终解决方案

因此，我们为什么不把组件的共享状态抽取出来，以一个全局单例模式管理呢？在这种模式下，我们的组件树构成了一个巨大的“视图”，不管在树的哪个位置，任何组件都能获取状态或者触发行为！

另外，通过定义和隔离状态管理中的各种概念并强制遵守一定的规则，我们的代码将会变得更结构化且易维护。
这就是 Vuex 背后的基本思想。

## 7.使用 Vuex 的正确姿势

### 背景：前端数据来源的多样性

#### 不同端的数据来源多样性

- 服务端接口
- 前端用户的输入
- 客户端信息（比如设备信息等）

#### 同一端数据来源的多样性

如果服务端的接口不是基于 restful 设计，或者接口内容是一些聚合的接口，比如服务端设计一个获取用户信息接口，返回了用户的 vip 信息、关注信息、粉丝信息等，同时设计了分别的获取 vip 信息接口、关注信息、粉丝信息接口，这样同一个内容在服务端这一端会有不同的来源。

如果前端组件之间对同一个状态的读取和操作没有做到复用，假设一个评论列表组件和弹幕组件之间，都用到了用户的评论信息，如果没有做到统一读取和更新，就会导致同样的状态信息有两个数据来源，最终导致同步问题。

### 数据读取，保证读取单一状态来源

需要保证不同的 View 或者组件读取某个状态信息都是从同一个地方读取，所以，回归到 Vuex 设计的本意上来，我们应该把同一状态信息集中管理。

### 数据存储，从聚合到原子

#### 思路

- 服务端尽量提供原子化的接口，比如 restful 风格
- 前端数据层设计成原子化，不存储聚合信息，所有的聚合信息都拆开存储

#### 前端数据存储原子化设计

下面是一个组队加速需求的状态设计：

	{
	  users: {
	    [uid]: {
	      userid: String,
	      nickName: String,
	      avatar: String,
	      // 存储team的索引
	      teams: String[]
	    }
	  },
	  teams: {
	    [groupId]: {
	      teamId: String,
	      taskId: String,
	      // 存储user的索引
	      users: String[]
	    }
	  },
	  tasks: {
	    [taskID]: {
	      taskID: String,
	      name: String,
	      gcid: String,
	      status: String,
	      suffix: String,
	      teams: String[]
	    }
	  },
	  increases: {
	    [gcid]: {
	      [userId]: {
	        uploadAmount: String,
	        increaseAmount: String
	      }
	    }
	  }
	}
	12345678910111213141516171819202122232425262728293031323334353637

数据结构设计原则

- 避免嵌套数据，数据结构扁平化
- 双向关系存储索引，适当的冗余来提升读取的效率

## 8.有了 Vuex 还需要什么？

### 数据校验设计

Vuex 对 state 的写入没有统一的校验机制，复杂的单页面应用应保证 state 内存储的数据结构和类型都是一致的，可以在 Vuex 这一层做一层类似组件的 props 验证那样的验证机制。

### 数据缓存设计

需要一套完整的缓存机制，包括缓存的读、写及过期清理逻辑。

- 持久化存储
    - localStorage
- 会话期的缓存
    - 内存
    - sessionStorage
- 跨页面会话期存储
    - localStorage

### 数据同步设计

- 独立同步
- 合并同步
- 聚合同步

#### 数据同步频率控制设计

> 就像一窝蜂的人去排队看演出，队伍很乱，看门的老大爷每隔 1 秒，让进一个人，这个叫 throttle，如果来了这一窝蜂的人，老大爷一次演出只让进一个人，下次演出才让下一个人进，这个就叫 debounce

- throttle：节流，控制单位时间内对特定内容的同步请求的最大次数
- debounce：去抖，连续的对同一个内容的同步请求我们只需要执行一次

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='596'%3e%3cpath d='M728.064 343.943529c-17.648941-2.891294-23.552-20.239059-26.503529-28.912941V104.026353C701.560471 46.200471 654.396235 0 595.425882 0c-53.007059 0-97.28 40.478118-106.134588 89.569882-29.997176 184.862118-138.541176 255.457882-217.630118 280.937412a26.142118 26.142118 0 0 0-18.130823 24.877177v560.067764c0 19.817412 16.022588 35.84 35.84 35.84h535.973647c56.018824-11.565176 94.328471-31.804235 120.892235-86.738823l120.832-416.105412c23.552-75.173647-14.757647-147.395765-100.231529-144.564706h-238.772706z m-571.813647 31.744H76.619294C35.358118 375.687529 0 410.383059 0 450.861176v462.426353c0 43.369412 32.406588 78.004706 76.619294 78.004706h79.631059c27.708235 0 50.115765-22.407529 50.115765-50.115764V425.863529a50.115765 50.115765 0 0 0-50.115765-50.115764z' data-evernote-id='152' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

14人点赞*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='64 64 896 896' focusable='false' class='js-evernote-checked' data-icon='right' width='1em' height='1em' fill='currentColor' aria-hidden='true' data-evernote-id='600'%3e%3cpath d='M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z' data-evernote-id='601' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='605'%3e%3cpath d='M771.413333 668.728889c-18.773333 3.015111-25.031111 20.878222-28.16 29.866667v217.884444c0 59.733333-49.948444 107.52-112.412444 107.52a115.427556 115.427556 0 0 1-112.412445-92.558222c-31.857778-190.919111-146.830222-263.850667-230.627555-290.133334a27.420444 27.420444 0 0 1-19.228445-26.168888V37.944889C268.572444 17.066667 285.582222 0 306.631111 0h567.864889c59.335111 11.946667 99.953778 32.824889 128 89.543111l128.113778 429.909333c24.974222 77.653333-15.644444 152.291556-106.211556 149.276445H771.413333z m-605.866666-32.824889H81.180444C37.546667 635.904 0 600.064 0 558.250667V80.611556C0 35.84 34.360889 0 81.180444 0H165.546667c29.297778 0 53.077333 23.779556 53.077333 53.077333v529.749334a53.077333 53.077333 0 0 1-53.077333 53.077333z' data-evernote-id='131' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

[*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='610'%3e%3cpath d='M178.390055 120.591045C111.268624 120.591045 56.888889 174.401955 56.888889 240.556383V903.97778C56.888889 970.302855 111.097977 1024 178.390055 1024h545.731364c67.121431 0 121.558049-53.81091 121.558049-120.02222V240.613265c0-66.268192-54.209088-120.02222-121.558049-120.02222H178.390055z m455.117432 301.136319H269.06087a30.147761 30.147761 0 0 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z m303.18409 301.136318a30.318409 30.318409 0 0 1-30.375291-30.318409V180.317742c0-66.268192-53.81091-120.02222-121.330519-120.022219H329.697688a30.147761 30.147761 0 0 1 0-60.23864l454.946784 0.056882C885.326618 0.113765 967.009987 80.887013 967.009987 180.602155v511.943118a30.318409 30.318409 0 0 1-30.31841 30.318409z m-303.18409-120.47728H269.06087a30.147761 30.147761 0 1 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z' data-evernote-id='142' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*前端开发](https://www.jianshu.com/nb/9727446)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='616'%3e%3cpath d='M232.727273 579.87878833C271.28679 579.87878833 302.545455 548.62012233 302.545455 510.06060633 302.545455 471.50108933 271.28679 440.24242433 232.727273 440.24242433 194.167756 440.24242433 162.909091 471.50108933 162.909091 510.06060633 162.909091 548.62012233 194.167756 579.87878833 232.727273 579.87878833ZM512 579.87878833C550.559516 579.87878833 581.818182 548.62012233 581.818182 510.06060633 581.818182 471.50108933 550.559516 440.24242433 512 440.24242433 473.440484 440.24242433 442.181818 471.50108933 442.181818 510.06060633 442.181818 548.62012233 473.440484 579.87878833 512 579.87878833ZM791.272727 579.87878833C829.832243 579.87878833 861.090909 548.62012233 861.090909 510.06060633 861.090909 471.50108933 829.832243 440.24242433 791.272727 440.24242433 752.713211 440.24242433 721.454545 471.50108933 721.454545 510.06060633 721.454545 548.62012233 752.713211 579.87878833 791.272727 579.87878833Z' data-evernote-id='162' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

"小礼物走一走，来简书关注我"
还没有人赞赏，支持一下

[[webp](../_resources/6e04abcee2ebef62dd2e30c2d6b80d25.webp)](https://www.jianshu.com/u/60f22559b79f)

[binggg_booker](https://www.jianshu.com/u/60f22559b79f)
总资产11 (约1.07元)共写了2.7W字获得211个赞共102个粉丝