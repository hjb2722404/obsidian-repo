图形学 坐标系空间变换

# 图形学 坐标系空间变换

[[webp](../_resources/c6afc1c019813dc6043e5e1046ab25ef.webp)](https://www.jianshu.com/u/1720030b17a1)

[白痴毛](https://www.jianshu.com/u/1720030b17a1)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='282'%3e%3cpath d='M751.144277 307.2l-123.016533-238.933333h159.778133a81.92 81.92 0 0 1 59.1872 25.258666l160.256 167.492267A27.306667 27.306667 0 0 1 987.620011 307.2h-236.475734z m270.506667 111.547733L640.927744 946.039467a27.306667 27.306667 0 0 1-48.128-24.234667L766.504277 375.466667h-56.388266l-170.5984 590.165333a27.306667 27.306667 0 0 1-52.462934 0.034133L315.500544 375.466667H259.112277l174.523734 545.5872a27.306667 27.306667 0 0 1-48.128 24.302933L5.160277 418.747733A27.306667 27.306667 0 0 1 27.346944 375.466667H999.464277a27.306667 27.306667 0 0 1 22.152534 43.281066zM18.301611 261.0176L178.557611 93.525333A81.92 81.92 0 0 1 237.744811 68.266667h159.744L274.506411 307.2H38.030677a27.306667 27.306667 0 0 1-19.729066-46.1824zM453.877077 68.266667h117.896534l122.9824 238.933333H330.894677l122.9824-238.933333z' data-evernote-id='165' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*0.9052017.09.28 17:33:37字数 1,720阅读 10,163

3D物体从三维坐标映射到2D屏幕上，要经过一系列的坐标系变换，这些坐标系如下：
1. model
物体本身（local）的坐标系，是相对坐标。

比如一个3D人物模型，头部某个点的坐标为（0，0，20），这是相对该模型的中心点（0，0，0）说的。当模型向前移动了5个单位，其中心点依旧是（0，0，0），头部那个点依旧是（0，0，20）

2. world
世界坐标系，即物体放在世界里的坐标，也就是大家最能理解的那个坐标。
还是上面的例子，他沿Z轴移动了5个单位后，中心点在世界坐标里变成了（0，0，5），头部那个点变成了（0，0，25）。
**物体的位移，缩放，旋转会改变它的世界坐标，不会改变它的model坐标。**
3. image
相机坐标系。

相机也是世界里的一个物体，相机坐标就是以相机位置为坐标原点，相机的朝向为Z轴方向的坐标系。因为我们在电脑里看到的物体其实都是“相机”帮助我们看的，“相机”就是我们的眼睛，所以要以相机为标准进行坐标转换。

**在model，world，image坐标系下，X,Y,Z的范围都是无穷大，只是坐标系的基准不一样而已。**
4. perspective (NDC, Normalized Device Coords)
透视坐标系。
这一步是将三维坐标向二维平面进行映射，经过透视变换之后，（x, y）的范围在[-1, 1]，z的范围在[0, 1]
可能有点难以理解，本文后面会有专门解释。
5. screen
屏幕坐标系。
因为屏幕是有分辨率的，比如1920×1080，所以还要再进行一次变换。

该坐标系的原点在屏幕左上角，x轴朝右，y轴朝下。x的范围在[0, xres-1]，y的范围在[0, yres-1]，即x是[0, 1920)，y是[0, 1080)。

z值是[0, MAXINT]，z=0就是屏幕那个平面，z=MAXINT就是无穷远。
经过这5个坐标系空间的变换，3维物体才最终投影到2维电脑平面上。

### 坐标系的变换矩阵

不清楚什么是变换矩阵，以及不清楚四维坐标的请看我之前的[文章](https://www.jianshu.com/p/ac1b34420be7)
**1. 从model变到world**
从模型本身的相对坐标变换到世界坐标，就是[平移，旋转，缩放](https://www.jianshu.com/p/ac1b34420be7)。
**2. 从world变到image（相机坐标）**
这一步是将物体在世界的坐标转换为相对相机的坐标。
相机也是世界里的物体，我们假定相机的中心点在世界里的位置是C（Cx, Cy, Cz）
相机正在看着某个方向，我们假定相机正在看的点的位置是I（Ix, Iy, Iz）

那么，相机的Z轴就是它看的方向的向量，即CI向量，也就是I - C = （Ix-Cx, Iy-Cy, Iz-Cz），我们将其标准化（即让它的模为1），得到Z轴单位向量。

然后我们取世界坐标系里的up向量（0，1，0）
![7943693-9a00f51bdf10d299.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125519.png)

得到Z轴后求X, Y轴有两个方法：
方法1：
通过up叉乘Z（注意顺序），我们可以得到一个向量X1，将X1标准化（即使其模为1），我们就得到了X轴的单位向量。
在通过Z轴的单位向量与X轴的单位向量叉乘，即Z×X（注意顺序），我们就得到了Y轴的单位向量。
方法2：
up' = up - (up·Z)Z
**注意**：（Z的模是1）
将up'标准化得到Y，Y×Z = X

然后我们就可以构造Xiw这么一个将世界坐标系投影到相机坐标系的变换矩阵了。
**如何构造？**
1）世界坐标系中，相机原点为（Cx, Cy, Cz），在相机坐标系中为（0，0，0）
所以，（0, 0, 0） = Xiw*（Cx, Cy, Cz）

2）世界坐标系中，相机的三个轴为X+C（Xx+Cx, Xy+Cy, Xz+Cz）, Y+C（Yx+Cx, Yy+Cy, Yz+Cz）, Z+C（Zx+Cx, Zy+Cy, Zz+Cz），但在相机坐标系下为（1，0，0），（0，1，0），（0，0，1）

所以
（1, 0, 0） = Xiw*（Xx+Cx, Xy+Cy, Xz+Cz）
（0, 1, 0） = Xiw*（Yx+Cx, Yy+Cy, Yz+Cz）
（0, 0, 1） = Xiw*（Zx+Cx, Zy+Cy, Zz+Cz）
结合上面2步的四个式子，可以求出Xiw

![7943693-1c892f6d46faf788.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125529.png)

它的几何意义就是先把坐标系移动到相机的原点处（最后一列Cx,Cy,Cz），然后再旋转来调整到相机的X,Y,Z轴。
**3. 从image变到perspective**
![7943693-46f80b787f75e59d.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125538.png)

当x=0时，yz平面如上图所示。
z = -d是我们的观察点，而Z=0就是相机的胶片，或者我们的视网膜，场景要投射到Z=0这个二维平面上。
我们需要将在相机坐标系里的（0，Y，Z）这个点投到Z = 0这个平面上，即a点，a点坐标为（0，y，0）。
根据三角形相似可知：
y/d = Y/(Z+d)
y = Yd/(Z+d) = Y/[(Z/d)+1]
我们对X和Z做同样的操作，最终，一个相机坐标系里的点（X, Y, Z）会变成
（X/[(Z/d)+1]，Y/[(Z/d)+1]，Z/[(Z/d)+1]），这样就投射到了Z=0这个平面上了。

**注意**
我们也不一定非要投到Z=0这个平面，投到Z=1,Z=d的平面都可以，式子是一样的。
我们可以看出来，这个变换就是将坐标除了一个(Z/d)+1。
因此，将四维坐标转换为Perspective坐标的变换矩阵为

![7943693-174c872dcff050d9.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125548.png)

经过该矩阵变换之后的四维坐标为（X, Y, Z, Z/d+1），转换为三维坐标即为（X/[(Z/d)+1]，Y/[(Z/d)+1]，Z/[(Z/d)+1]）

Perspective矩阵的定义的X, Y的范围在[-1,1]，而X/[(Z/d)+1]，Y/[(Z/d)+1]的范围是负无穷到正无穷，所以一旦X/[(Z/d)+1]，Y/[(Z/d)+1]超出[-1, 1]的范围，就直接扔掉不显示在屏幕上了。

Perspective矩阵定义的Z的范围在[0,1]，所以还要将Z进一步限制，所以最终的矩阵为
![7943693-7d07542658b5f1c8.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125554.png)

这样子z的值就成了(Z/d)/[(Z/d)+1]，即1/[1+d/Z]，满足[0,1]这个范围了。
而这个d又是多少呢？

![7943693-40a8140db6588e14.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125601.png)

FOV (Field of View)是定义相机视锥垂直方向（y轴方向）的张角（**它是个角度**），该张角与Z=0这个投影平面的交点是-1和1，因为x，y的范围是[-1,1]。

从上图可以看出，1/d就是tan（FOV/2）

**4. 从perspective变到screen**
定义屏幕分辨率为xs × rs
要将透视坐标系里的点映射过来，这个变换矩阵怎么构造？(参考Xiw)
1）首先我们先构造一个4维标准矩阵，即对角线都是1，其余都是0。

2）屏幕坐标系的原点是左上角，而perspective里的原点（0，0）在屏幕中应该位于屏幕中央，即（xs/2, ys/2）。那么perspective里的原点（0，0）会映射为（xs/2, ys/2），即位移一个（xs/2, ys/2，0）。

所以4维矩阵的最后一列是（xs/2, ys/2，0，1）

3）屏幕坐标系中x的范围是[0, xs)，y的范围是[0, ys)。而Perspective坐标系中x和y的范围是[-1,1]，所以这个映射还要满足-1映射到0，1映射到xs或ys。

目前为止，我们的4维矩阵变成了这样：
![7943693-87b10dfde55b0e06.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125609.png)

**注意：**我们可以很明显的发现矩阵第二行第二列是负的，这是因为之前的坐标系都是y轴正方向朝上的，而屏幕坐标系是y轴正方向朝下的，是反的，所以是负号，即perspective里的-1映射到屏幕里的ys，1映射到屏幕里的0。

4）屏幕坐标系中z的范围是[0, MAXINT]，Perspective坐标系中z是[0,1]，所以再对z进一步限制，即1映射到MAXINT，得到最终结果。

![7943693-8b30e915acaff044.png](https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210102125616.png)

所以，一个3D物体显示到电脑屏幕上，要经过4重坐标系变换。
**screen** Xsp **perspective** (NDC) Xpi **image** Xiw **world** Xwm **model**
在实际的渲染引擎运行中，Xsp和Xpi基本不会变，因为你的屏幕分辨率很少会变动。Xiw会在相机移动和旋转时改变。Xwm会在物体平移，旋转，缩放时改变。

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='460'%3e%3cpath d='M728.064 343.943529c-17.648941-2.891294-23.552-20.239059-26.503529-28.912941V104.026353C701.560471 46.200471 654.396235 0 595.425882 0c-53.007059 0-97.28 40.478118-106.134588 89.569882-29.997176 184.862118-138.541176 255.457882-217.630118 280.937412a26.142118 26.142118 0 0 0-18.130823 24.877177v560.067764c0 19.817412 16.022588 35.84 35.84 35.84h535.973647c56.018824-11.565176 94.328471-31.804235 120.892235-86.738823l120.832-416.105412c23.552-75.173647-14.757647-147.395765-100.231529-144.564706h-238.772706z m-571.813647 31.744H76.619294C35.358118 375.687529 0 410.383059 0 450.861176v462.426353c0 43.369412 32.406588 78.004706 76.619294 78.004706h79.631059c27.708235 0 50.115765-22.407529 50.115765-50.115764V425.863529a50.115765 50.115765 0 0 0-50.115765-50.115764z' data-evernote-id='159' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

28人点赞*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='64 64 896 896' focusable='false' class='js-evernote-checked' data-icon='right' width='1em' height='1em' fill='currentColor' aria-hidden='true' data-evernote-id='464'%3e%3cpath d='M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z' data-evernote-id='465' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='469'%3e%3cpath d='M771.413333 668.728889c-18.773333 3.015111-25.031111 20.878222-28.16 29.866667v217.884444c0 59.733333-49.948444 107.52-112.412444 107.52a115.427556 115.427556 0 0 1-112.412445-92.558222c-31.857778-190.919111-146.830222-263.850667-230.627555-290.133334a27.420444 27.420444 0 0 1-19.228445-26.168888V37.944889C268.572444 17.066667 285.582222 0 306.631111 0h567.864889c59.335111 11.946667 99.953778 32.824889 128 89.543111l128.113778 429.909333c24.974222 77.653333-15.644444 152.291556-106.211556 149.276445H771.413333z m-605.866666-32.824889H81.180444C37.546667 635.904 0 600.064 0 558.250667V80.611556C0 35.84 34.360889 0 81.180444 0H165.546667c29.297778 0 53.077333 23.779556 53.077333 53.077333v529.749334a53.077333 53.077333 0 0 1-53.077333 53.077333z' data-evernote-id='138' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

[*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='474'%3e%3cpath d='M178.390055 120.591045C111.268624 120.591045 56.888889 174.401955 56.888889 240.556383V903.97778C56.888889 970.302855 111.097977 1024 178.390055 1024h545.731364c67.121431 0 121.558049-53.81091 121.558049-120.02222V240.613265c0-66.268192-54.209088-120.02222-121.558049-120.02222H178.390055z m455.117432 301.136319H269.06087a30.147761 30.147761 0 0 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z m303.18409 301.136318a30.318409 30.318409 0 0 1-30.375291-30.318409V180.317742c0-66.268192-53.81091-120.02222-121.330519-120.022219H329.697688a30.147761 30.147761 0 0 1 0-60.23864l454.946784 0.056882C885.326618 0.113765 967.009987 80.887013 967.009987 180.602155v511.943118a30.318409 30.318409 0 0 1-30.31841 30.318409z m-303.18409-120.47728H269.06087a30.147761 30.147761 0 1 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z' data-evernote-id='149' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*游戏引擎笔记](https://www.jianshu.com/nb/16927263)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='480'%3e%3cpath d='M232.727273 579.87878833C271.28679 579.87878833 302.545455 548.62012233 302.545455 510.06060633 302.545455 471.50108933 271.28679 440.24242433 232.727273 440.24242433 194.167756 440.24242433 162.909091 471.50108933 162.909091 510.06060633 162.909091 548.62012233 194.167756 579.87878833 232.727273 579.87878833ZM512 579.87878833C550.559516 579.87878833 581.818182 548.62012233 581.818182 510.06060633 581.818182 471.50108933 550.559516 440.24242433 512 440.24242433 473.440484 440.24242433 442.181818 471.50108933 442.181818 510.06060633 442.181818 548.62012233 473.440484 579.87878833 512 579.87878833ZM791.272727 579.87878833C829.832243 579.87878833 861.090909 548.62012233 861.090909 510.06060633 861.090909 471.50108933 829.832243 440.24242433 791.272727 440.24242433 752.713211 440.24242433 721.454545 471.50108933 721.454545 510.06060633 721.454545 548.62012233 752.713211 579.87878833 791.272727 579.87878833Z' data-evernote-id='169' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

"小礼物走一走，来简书关注我"
还没有人赞赏，支持一下

[[webp](../_resources/273701df77c4b550718144cdda5046d4.webp)](https://www.jianshu.com/u/1720030b17a1)

[白痴毛](https://www.jianshu.com/u/1720030b17a1)上海交通大学软件工程本科，南加州大学游戏开发硕士在读。 一人独立游戏开发。 码农，作画，编曲，写作。

总资产5 (约0.46元)共写了1.2W字获得149个赞共237个粉丝