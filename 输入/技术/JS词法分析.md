JS词法分析

# JS词法分析

[[webp](../_resources/4c41ddd49a4a149cdc4e65eb542e4c50.webp)](https://www.jianshu.com/u/0df47672cea7)

[JunChow520](https://www.jianshu.com/u/0df47672cea7)[![19c2bea4-c7f7-467f-a032-4fed9acbc55d](../_resources/4e28c0ab001ae5f09cd4a04317f5b6ea.png)](https://www.jianshu.com/mobile/creator)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='289'%3e%3cpath d='M751.144277 307.2l-123.016533-238.933333h159.778133a81.92 81.92 0 0 1 59.1872 25.258666l160.256 167.492267A27.306667 27.306667 0 0 1 987.620011 307.2h-236.475734z m270.506667 111.547733L640.927744 946.039467a27.306667 27.306667 0 0 1-48.128-24.234667L766.504277 375.466667h-56.388266l-170.5984 590.165333a27.306667 27.306667 0 0 1-52.462934 0.034133L315.500544 375.466667H259.112277l174.523734 545.5872a27.306667 27.306667 0 0 1-48.128 24.302933L5.160277 418.747733A27.306667 27.306667 0 0 1 27.346944 375.466667H999.464277a27.306667 27.306667 0 0 1 22.152534 43.281066zM18.301611 261.0176L178.557611 93.525333A81.92 81.92 0 0 1 237.744811 68.266667h159.744L274.506411 307.2H38.030677a27.306667 27.306667 0 0 1-19.729066-46.1824zM453.877077 68.266667h117.896534l122.9824 238.933333H330.894677l122.9824-238.933333z' data-evernote-id='170' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*0.4272018.01.19 02:46:22字数 1,337阅读 2,249

JS是弱类型语言，所谓弱类型只是表明该语言在表达式运算中不强制校验运算元的数据类型，而并不表明该语言是否具有类型系统。一般而言，JS的变量可从作用域角度分为全局变量和局部变量。

任何程序设计语言都有作用域（scope）的概念，简单来说，作用域就是变量与函数的**可访问范围**，也就是说，作用域控制着变量与函数的**可见性**和**生命周期**。换句话说，函数的变量有其作用域，也就是引用变量时在哪个**范围**内查找该变量。那么这个范围又在哪里呢？这个范围其实就是**活动对象（AO）**。在函数调用的瞬间，会产生一个活动对象，活动对象的属性上存储着该函数所能引用到的变量。

![4933701-099d9f5f33274962.png](https://gitee.com/hjb2722404/tuchuang/raw/master/img/20210108145735.png)
JS执行流程

## 作用域

在JS中函数嵌套是非常普遍的，在函数嵌套中，对变量是如何寻找的呢？

	var a = 1;
	function fn(){
	    var b = 2;
	    function func(){
	        var c = 3;
	        console.log(a,b,c);// 1 2 3
	    }
	    func();
	}
	123456789

JS中对变量的寻找是由内向外，首先在函数内部寻找，若寻找不到，则逐级向外寻找直到全局（window）区域。
声明变量`var`的作用是什么呢？

	console.log(window.a, window.b);// undefined undefined
	function fn(){
	    a = 1;// 未添加var表示仅仅是一个赋值操作，从fn域内向外寻找变量a直到全局（window）。
	    var b = 2;
	}
	fn();
	console.log(window.a, window.b);// 1 undefined
	1234567

`var` 是在函数运行的上下文（EC）中，声明一个变量。为无`var`则仅仅表示一个赋值操作，但不要狭隘地理解为“声明了一个全局变量”。

	function fn(){
	    var a;
	    function func(){
	        a = 1;
	        b = 2;
	    }
	    func();
	}
	fn();
	
	console.log(b);// 2
	// 以window.prop引用全局变量，寻找不到时则作为window的某个属性不存在返回undefined。
	console.log(window.a);// undefined
	// 直接使用变量引用变量，若寻找不到则直接报错。
	console.log(a);// Uncaught ReferenceError: a is not defined
	123456789101112131415

一个极容易出错，又非常基础的JS面试题。

	var v = 'global';
	function fn(){
	    console.log(v);// global
	    console.log(l);// undefined
	    var l = 'local';
	}
	fn();
	1234567

JS代码自上而下执行，但是JS代码整体运行分为两个阶段：**词法分析期**和**运行期**。在JS代码自上而下执行前，会有一个“**词法分析**过程”。

	var v = 'global';
	function fn(){
	    console.log(v);// global
	    console.log(l);// Uncaught ReferenceError: l is not defined
	    l = 'local';
	}
	fn();
	1234567

## 词法分析

JS代码运行前，有一个类似编译的过程即词法分析，词法分析主要有3个步骤：分析函数参数、分析变量声明、分析函数声明。

	function fn(func){
	    console.log(func);// func(){console.log(func);}
	    function func(){
	        console.log(func);// func(){console.log(func);}
	    }
	    func();
	}
	fn(1);
	12345678

词法分析的具体步骤：在函数运行的瞬间，会生成一个活动对象（AO, Active Object）。
1. 分析函数参数

- 将函数的形参添加为AO属性，属性的默认值为`undefined`。
- 接收函数的实参，并覆盖原属性值。

1. 分析变量声明/分析局部变量

- 若AO中不存在与声明的变量所对应的属性，则添加AO属性为`undefined`。
- 若AO中已存在与声明的变量所对应的属性，则不做任何修改。

1. 分析函数声明

- 若AO中存在与函数名所对应的属性，则覆盖原属性为一个函数表达式。

	function fn(func){
	    console.log(func);// func(){console.log(func);}
	    var func = 100;
	    function func(){
	        console.log(func);// Uncaught TypeError: func is not a function
	    }
	    // func();
	    console.log(func);// 100
	}
	fn(1);
	12345678910

具体分析如下

	function fn(func){
	    console.log(func);
	}
	/*分析函数参数*/
	// 将函数的形参添加为AO属性，属性的默认值为undefined。
	fn();// undefined
	// 接收函数的实参，并覆盖原属性值。
	fn(1);// 1
	12345678
	function fn(func){
	    console.log(func);// 1
	    /*分析变量声明/分析局部变量*/
	    // 若AO中已存在与声明的变量所对应的属性，则不做任何修改。
	    var func = 100;// 执行过程：对变量进行赋值
	    console.log(func);// 100
	}
	fn(1);
	------------------------------------------------------------------------------------------------------------
	AO = {}
	分析函数参数
	AO = {func:undefined}
	AO = {func:1}
	分析局部变量
	AO = {func:1}
	运行阶段赋值
	AO = {func:100}
	1234567891011121314151617
	function fn(func){
	    console.log(func);// func(){}
	    /*分析变量声明/分析局部变量*/
	    // 若AO中已存在与声明的变量所对应的属性，则不做任何修改。
	    var func = 100;// 执行过程：对变量进行赋值
	    console.log(func);// 100
	    /*分析函数声明*/
	    // 若AO中存在与函数名所对应的属性，则覆盖原属性为一个函数表达式。
	    function func(){
	
	    }
	    console.log(func); // 100
	}
	fn(1);
	------------------------------------------------------------------------------------------------------------
	AO = {}
	分析函数参数
	AO = {func:undefined}
	AO = {func:1}
	分析局部变量
	AO = {func:1}
	运行阶段赋值
	AO = {func:100}
	分析函数声明
	AO = {func:function(){}}
	12345678910111213141516171819202122232425

## 函数声明与函数表达式

JS被称为“披着C外衣的List语言”，List语言是一种强大的函数式语言。函数式语言中函数是一等公民，函数可作为赋值给变量、函数也可以作为参数来传递。

	// 函数声明，全局内得到了一个fn变量且值为function。
	function fn(){
	
	}
	// 函数表达式，仅仅是一个变量赋值的过程，值是谁呢？
	// 是右侧函数表达式返回的结果
	var fn = function(){
	
	}
	123456789

在词法分析时，函数声明和函数表达式有着本质的区别。函数声明在词法分析阶段就后发挥作用。而函数表达式只有到运行阶段才会发挥作用。

	// jQuery源码分析：
	// 声明一个内层表达式返回值是一个函数，然后立即调用函数。
	// 内层函数没有起名字，称为匿名函数。
	// 这种手法中匿名函数立即执行，好处是不污染全局变量。
	// 称之为立即执行匿名表达式
	(function(window,undefined){
	
	})(window);
	// 为什么传入window而不传入undefined呢？
	// 传入window是为了速度
	// jQuery为了加快内部查找局部变量的速度，而直接将window以参数形式传入。
	// 这样的话，window就在jQuery内部的AO上，那查找速度就会快。
	// 不传入undefined时候为了安全
	// 因为在IE和FF的低版本中，undefined竟然可以重新赋值，如undefined=3。
	// 声明undefined局部变量，名字是undefined。同时又不传参，值自然是undefined。
	// 防止外界对undefined的污染。
	function(){
	  function(){
	    function(){
	      function(){
	        // document将会沿着作用域链由内向外层层上找，直到最外层的全局对象window。
	        document.getElementById('sidebar');
	      }
	     }
	  }
	}
	1234567891011121314151617181920212223242526

函数声明与函数表达式有什么区别呢？

ECMAScript规范规定：函数声明必须带有标识符（identifier），也就是函数名称。而函数表达式则可省略。实际上，解析器在向执行环境中加载数据时，对函数声明和函数表达式并非一视同仁。解析器会率先读取函数声明，并使其执行任何代码之前可用（可访问）。至于函数表达式，则必须等到解析器执行到它所在代码行时，才会真正被解析执行。

	console.log(sum(1,2));// 3
	function sum(i, j){
	  return i + j;
	}
	1234

代码执行前，JS解析器通过名为函数声明提升（function declaration hoisting）的过程，读取并将函数声明添加到执行环境中。对代码求值时，JS引擎也能把函数声明提升到顶部。

	console.log(sum(1,2)); // Uncaught TypeError: sum is not a function
	var sum = function(i,j){
	  return i + j;
	}
	1234

将函数声明修改为等价的函数表达式，代码执行时出现错误。原因在于函数位于一个初始化语句中，而不是一个函数声明。换句话说，在执行到函数所在的语句之前，变量`sum`中不会保存有对函数的引用。而且，由于错误的出现，代码也就不会向下执行了。

如何判断是函数声明还是函数表达式呢？

ECMAScript是通过上下文来区分的，如果函数作为赋值表达式的一部分的话，那它就是一个函数表达式。如果函数被包含在一个函数体内，或位于程序最顶端的话，那它就是一个函数声明。

	function fn(func){
	  console.log(func);// 1
	  var func = 100;
	  console.log(func);// 100
	  // 将函数表达式赋值给变量
	  func = function(){
	    console.log(func);// f (){console.log(func);}
	  }
	  func();
	  console.log(func);// f (){console.log(func);}
	}
	fn(1);
	123456789101112

## 作用域链

> 作用域链就是函数由内向外所产生的活动对象（AO）的链

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='1358'%3e%3cpath d='M728.064 343.943529c-17.648941-2.891294-23.552-20.239059-26.503529-28.912941V104.026353C701.560471 46.200471 654.396235 0 595.425882 0c-53.007059 0-97.28 40.478118-106.134588 89.569882-29.997176 184.862118-138.541176 255.457882-217.630118 280.937412a26.142118 26.142118 0 0 0-18.130823 24.877177v560.067764c0 19.817412 16.022588 35.84 35.84 35.84h535.973647c56.018824-11.565176 94.328471-31.804235 120.892235-86.738823l120.832-416.105412c23.552-75.173647-14.757647-147.395765-100.231529-144.564706h-238.772706z m-571.813647 31.744H76.619294C35.358118 375.687529 0 410.383059 0 450.861176v462.426353c0 43.369412 32.406588 78.004706 76.619294 78.004706h79.631059c27.708235 0 50.115765-22.407529 50.115765-50.115764V425.863529a50.115765 50.115765 0 0 0-50.115765-50.115764z' data-evernote-id='164' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

4人点赞*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='64 64 896 896' focusable='false' class='js-evernote-checked' data-icon='right' width='1em' height='1em' fill='currentColor' aria-hidden='true' data-evernote-id='1362'%3e%3cpath d='M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z' data-evernote-id='1363' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='1367'%3e%3cpath d='M771.413333 668.728889c-18.773333 3.015111-25.031111 20.878222-28.16 29.866667v217.884444c0 59.733333-49.948444 107.52-112.412444 107.52a115.427556 115.427556 0 0 1-112.412445-92.558222c-31.857778-190.919111-146.830222-263.850667-230.627555-290.133334a27.420444 27.420444 0 0 1-19.228445-26.168888V37.944889C268.572444 17.066667 285.582222 0 306.631111 0h567.864889c59.335111 11.946667 99.953778 32.824889 128 89.543111l128.113778 429.909333c24.974222 77.653333-15.644444 152.291556-106.211556 149.276445H771.413333z m-605.866666-32.824889H81.180444C37.546667 635.904 0 600.064 0 558.250667V80.611556C0 35.84 34.360889 0 81.180444 0H165.546667c29.297778 0 53.077333 23.779556 53.077333 53.077333v529.749334a53.077333 53.077333 0 0 1-53.077333 53.077333z' data-evernote-id='143' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

[*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='1372'%3e%3cpath d='M178.390055 120.591045C111.268624 120.591045 56.888889 174.401955 56.888889 240.556383V903.97778C56.888889 970.302855 111.097977 1024 178.390055 1024h545.731364c67.121431 0 121.558049-53.81091 121.558049-120.02222V240.613265c0-66.268192-54.209088-120.02222-121.558049-120.02222H178.390055z m455.117432 301.136319H269.06087a30.147761 30.147761 0 0 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z m303.18409 301.136318a30.318409 30.318409 0 0 1-30.375291-30.318409V180.317742c0-66.268192-53.81091-120.02222-121.330519-120.022219H329.697688a30.147761 30.147761 0 0 1 0-60.23864l454.946784 0.056882C885.326618 0.113765 967.009987 80.887013 967.009987 180.602155v511.943118a30.318409 30.318409 0 0 1-30.31841 30.318409z m-303.18409-120.47728H269.06087a30.147761 30.147761 0 1 1 0-60.238641h364.503499a30.147761 30.147761 0 0 1 0 60.238641z' data-evernote-id='154' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*js](https://www.jianshu.com/nb/10240376)

*![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em' fill='currentColor' aria-hidden='true' focusable='false' class='js-evernote-checked' data-evernote-id='1378'%3e%3cpath d='M232.727273 579.87878833C271.28679 579.87878833 302.545455 548.62012233 302.545455 510.06060633 302.545455 471.50108933 271.28679 440.24242433 232.727273 440.24242433 194.167756 440.24242433 162.909091 471.50108933 162.909091 510.06060633 162.909091 548.62012233 194.167756 579.87878833 232.727273 579.87878833ZM512 579.87878833C550.559516 579.87878833 581.818182 548.62012233 581.818182 510.06060633 581.818182 471.50108933 550.559516 440.24242433 512 440.24242433 473.440484 440.24242433 442.181818 471.50108933 442.181818 510.06060633 442.181818 548.62012233 473.440484 579.87878833 512 579.87878833ZM791.272727 579.87878833C829.832243 579.87878833 861.090909 548.62012233 861.090909 510.06060633 861.090909 471.50108933 829.832243 440.24242433 791.272727 440.24242433 752.713211 440.24242433 721.454545 471.50108933 721.454545 510.06060633 721.454545 548.62012233 752.713211 579.87878833 791.272727 579.87878833Z' data-evernote-id='174' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)*

"小礼物走一走，来简书关注我"
还没有人赞赏，支持一下

[[webp](../_resources/290c1a0a7cc871d428d2a19da30decfe.webp)](https://www.jianshu.com/u/0df47672cea7)

[JunChow520](https://www.jianshu.com/u/0df47672cea7)[![19c2bea4-c7f7-467f-a032-4fed9acbc55d](../_resources/4e28c0ab001ae5f09cd4a04317f5b6ea.png)](https://www.jianshu.com/mobile/creator)阅读提升上限，实践突破下限。

总资产884 (约80.03元)共写了112.9W字获得1,938个赞共841个粉丝